# PAGE_FILE_COMPONENT

## 概要
システムの下部コンポーネントであるページファイルコンポーネントでは
上位レベルのクライアントコンポーネントがページ単位でファイルI/Oを実行するための機能を提供する。

PFコンポーネントではページファイルの作成、破棄、オープン、クローズ、特定のファイルのページのスキャン
、特定のファイルの特定のページの読み取り、特定のファイルのページの追加と削除を行うメソッドが提供される。

## インターフェースの設計
各クラスの名前はPFで始めるようにする。
コンポーネント内の各メソッドは整数のコードを返すようにする。
コード0は正常終了
ゼロ以外は例外条件またはエラーが発生したことを示す。

## ページのバッファプール
ファイルのページ上のデータにアクセスするにはまずメインメモリ内のバッファプールにページを読み取り、
次にそこでそのデータ操作(読み取り、書き込み)を行う必要がある。
ページがメモリ内にあり、そのデータが操作に利用できる間、そのページはバッファプールに固定(pinned)されている。
固定されたページは明示的に解除されるまでバッファプールに残る。
クライアントはページ上のデータ操作が完了すると、ページの固定を解除する。
ページの固定を解除しても、必ずしもページがバッファから削除される訳ではない。
過程を解除されたページはバッファプールのスペースが必要にならない間はメモリ内に保持される。

PFコンポーネントが新しいページをメモリに読み取る必要がありバッファプールに空いているスペースが残っていない時に
PFコンポーネントは固定されていないページを選択してバッファプールから削除し、そのスペースを再利用する。
PFコンポーネントは、直近で使用していない(LRU)ページ置換ポリシー(https://ja.wikipedia.org/wiki/Least_Recently_Used)を使用する。
ページがバッファプールから削除されると、そのページが「ダーティ」としてマーキングされている場合に限り、そのページはディスク上の
ファイルにコピーされて戻される。
ダーティページはバッファから削除されるまでは自動的にディスクに書き込まれない。
ただし、PFクライアントではバッファからページを削除せずに、特定のページのコンテンツを強制するか(ディスクに書き込む)
ファイルのすべてのダーティページを強制的に書き込む明示的なリクエストを常に送信する。

ページを無駄にメモリに固定しないように注意が必要である。実装するPFコンポーネントクライアントは各操作で必要なページがバッファプール内に
ないことを前提とする設計もできる。
クライアントは必要なページをフェッチし、それらに対し適切なアクションを実行し、ページの固定を解除する。
また一方で特定のページが再び必要になる可能性もある(ページがすぐに再度使用される場合は、大抵バッファプールに残っているはずである)
PFコンポーネントでは、途中で固定を解除されることなく、同じページを複数回固定することができる。
この場合、固定解除操作の数が固定操作の数と一致するまで、固定されたページ解除されない。
ページを取得して固定するたびに完了したら解除することを忘れないようにしなければいけない。
ページの固定解除に失敗すると、バッファプールが徐々にいっぱいになり、最終的にはページのフェッチができなくなる。(PFコンポーネントはネガティブコードを返す)

## ページ番号
ファイル内のページは、ディスク上のファイル内の位置に対応するページ番号によって識別される。
最初にファイルを作成してページを割り当てる時、ページ番号は連続したものになる。
ただし、ページが削除されると新しく割り当てられたページの番号は連続しない。
PFコンポーネントは、LIFO(スタック)アルゴリズムを使用して、以前に割り当てられたページを再度割り当てる。
すなわち、最後に削除された(再割当てされていない)ページを再度割り当てる。
以前に割り当てられたページが使用可能な場合、まったく新しいページが割り当てられることはない。


GetFirstPageおよびGetNextPageのメソッドを呼び出してファイルをスキャンすると、番号順にページが取得されて削除に割り当てられた
ページはスキップされ、現在有効な最大のページ番号でスキャンが終了する。
スキャンの順序数が保証され、最初のページ番号が連続されているため、クライアントは各ファイルの最初の1つ以上のページを
ヘッダー情報に使用するポリシーを実装することができる。

## ページの割当解除
PFコンポーネント自体はPFファイルページの割当てを解除するが、これらのページの基礎となるUNIXファイルシステムに返却はしない。
なぜならほとんどのUNIXファイルシステムにはファイルの空きスペースを利用する機能がないため。
ただし、ファイルの崩壊が発生する可能性があることを想定してPFクライアントを作成する必要がある。
つまり、ページ破棄後に実際のファイル圧縮を行うようにPFコンポーネントが変更された場合、コードを変更する必要はない。

