# PAGE_FILE_COMPONENT

## 概要
システムの下部コンポーネントであるページファイルコンポーネントでは
上位レベルのクライアントコンポーネントがページ単位でファイルI/Oを実行するための機能を提供する。

PFコンポーネントではページファイルの作成、破棄、オープン、クローズ、特定のファイルのページのスキャン
、特定のファイルの特定のページの読み取り、特定のファイルのページの追加と削除を行うメソッドが提供される。

## インターフェースの設計
各クラスの名前はPFで始めるようにする。
コンポーネント内の各メソッドは整数のコードを返すようにする。
コード0は正常終了
ゼロ以外は例外条件またはエラーが発生したことを示す。

## ページのバッファプール
ファイルのページ上のデータにアクセスするにはまずメインメモリ内のバッファプールにページを読み取り、
次にそこでそのデータ操作(読み取り、書き込み)を行う必要がある。
ページがメモリ内にあり、そのデータが操作に利用できる間、そのページはバッファプールに固定(pinned)されている。
固定されたページは明示的に解除されるまでバッファプールに残る。
クライアントはページ上のデータ操作が完了すると、ページの固定を解除する。
ページの固定を解除しても、必ずしもページがバッファから削除される訳ではない。
過程を解除されたページはバッファプールのスペースが必要にならない間はメモリ内に保持される。

PFコンポーネントが新しいページをメモリに読み取る必要がありバッファプールに空いているスペースが残っていない時に
PFコンポーネントは固定されていないページを選択してバッファプールから削除し、そのスペースを再利用する。
PFコンポーネントは、直近で使用していない(LRU)ページ置換ポリシー(https://ja.wikipedia.org/wiki/Least_Recently_Used)を使用する。
ページがバッファプールから削除されると、そのページが「ダーティ」としてマーキングされている場合に限り、そのページはディスク上の
ファイルにコピーされて戻される。
ダーティページはバッファから削除されるまでは自動的にディスクに書き込まれない。
ただし、PFクライアントではバッファからページを削除せずに、特定のページのコンテンツを強制するか(ディスクに書き込む)
ファイルのすべてのダーティページを強制的に書き込む明示的なリクエストを常に送信する。

ページを無駄にメモリに固定しないように注意が必要である。実装するPFコンポーネントクライアントは各操作で必要なページがバッファプール内に
ないことを前提とする設計もできる。
クライアントは必要なページをフェッチし、それらに対し適切なアクションを実行し、ページの固定を解除する。
また一方で特定のページが再び必要になる可能性もある(ページがすぐに再度使用される場合は、大抵バッファプールに残っているはずである)
PFコンポーネントでは、途中で固定を解除されることなく、同じページを複数回固定することができる。
この場合、固定解除操作の数が固定操作の数と一致するまで、固定されたページ解除されない。
ページを取得して固定するたびに完了したら解除することを忘れないようにしなければいけない。
ページの固定解除に失敗すると、バッファプールが徐々にいっぱいになり、最終的にはページのフェッチができなくなる。(PFコンポーネントはネガティブコードを返す)

## ページ番号
ファイル内のページは、ディスク上のファイル内の位置に対応するページ番号によって識別される。
最初にファイルを作成してページを割り当てる時、ページ番号は連続したものになる。
ただし、ページが削除されると新しく割り当てられたページの番号は連続しない。
PFコンポーネントは、LIFO(スタック)アルゴリズムを使用して、以前に割り当てられたページを再度割り当てる。
すなわち、最後に削除された(再割当てされていない)ページを再度割り当てる。
以前に割り当てられたページが使用可能な場合、まったく新しいページが割り当てられることはない。


GetFirstPageおよびGetNextPageのメソッドを呼び出してファイルをスキャンすると、番号順にページが取得されて削除に割り当てられた
ページはスキップされ、現在有効な最大のページ番号でスキャンが終了する。
スキャンの順序数が保証され、最初のページ番号が連続されているため、クライアントは各ファイルの最初の1つ以上のページを
ヘッダー情報に使用するポリシーを実装することができる。

## ページの割当解除
PFコンポーネント自体はPFファイルページの割当てを解除するが、これらのページの基礎となるUNIXファイルシステムに返却はしない。
なぜならほとんどのUNIXファイルシステムにはファイルの空きスペースを利用する機能がないため。
ただし、ファイルの崩壊が発生する可能性があることを想定してPFクライアントを作成する必要がある。
つまり、ページ破棄後に実際のファイル圧縮を行うようにPFコンポーネントが変更された場合、コードを変更する必要はない。

## スクラッチページ
ファイルに関連付けられたページにすべてのデータを保存し、操作する。
場合によってはデータを一時的にスクラッチメモリに保存して操作する必要がある。

## PFインターフェース
PFインターフェースはPF_Managerクラス、PF_FileHandleクラス、PF_PageHandleクラスの3クラスで構成される。
更に、ゼロ以外のPF戻りコードに関連付けられたメッセージを出力するPF_PrintErrorルーチンもある。

**PF_Managerクラス**
PF_Managerクラスはスクラッチページの割当と破棄とともにページファイルの作成、削除、オープン、クローズ処理を行う。
プログラムはこのクラスのインスタンスを1つだけ作成する必要があり、PFコンポーネントファイル管理のすべてのリクエストは
そのインスタンスに送られる必要がある。
以下ではクラス宣言のパブリックメソッドが最初に示され、次にメソッドの説明が続く。
クラス宣言の最初の2つのメソッドは、クラスのコンストラクタメソッドとデストラクタメソッドである。
それ以外の各メソッドは、typeの値RCを返す。
戻りコード0は正常終了を示す。ゼロ以外のコードは、例外条件またはエラーが発生したことを示す。

```cpp
class PF_Manager {
public:
  PF_Manager(); // コンストラクタ
  ~PF_Manager(); // デストラクタ
  RC CreateFile (const char *fileName); // 新しくファイルを作成する
  RC DestroyFile(const char *fileName); // ファイルを削除する
  RC OpenFile(const char *fileName, PF_FileHandle &fileHandle); // ファイルを開く
  RC CloseFile(PF_FileHandle &fileHandle); // ファイルを閉じる
  RC AllocateBlock(char *&buffer); // バッファー内に新しいスクラッチページを配分する
  RC DisposeBlock(char *buffer); // スクラッチページを破棄する
};
```

**RC CreateFile (const char *fileName)**
このメソッドはfileNameというページファイルを作成する。
ページファイルはまだ存在していないものとする。

**RC DestroyFile(const char *fileName)**
このメソッドはfileNameというページファイルを削除する。
ページファイルは存在しているものとする。

**RC OpenFile (const char *fileName, PF_FileHandle &fileHandle)**
このメソッドはfileNameという名前のページファイルを開く。
ファイルはすでに存在しており、CreateFileメソッドを使用して作成されている必要がある。
メソッドが成功するとfileHandleアドレスがパラメータとして渡されたオブジェクトが、開いているファイルのハンドルになる。
ファイルハンドルは、ファイルのページを操作するために使用される。
fileHandleメソッドに渡されたときに、openFileがすでに開いているファイルのハンドルである場合、これは(正の)エラーになる。
必要に応じて、fileHandleオブジェクトを使用して同じファイルを複数回開いてもエラーではない。
OpenFileメソッドを呼び出すたびに、開いているファイルの新しいインスタンスが作成される。

**RC CloseFile (PF_FileHandle &fileHandle)**
このメソッドはfileHandleによって参照される開いているファイルインスタンスを閉じる。
ファイルはOpenFileメソッドを使用して開かれている必要がある。
ファイルが閉じられると、ファイルのすべてのページがバッファプールからフラッシュされる。
ファイルのすべてのページのいずれかがまだバッファプールに固定されているときにファイルを閉じようとすると(正の)エラーが発生する。

**RC AllocateBlock (char *&buffer)**
このメソッドはバッファプールにスクラッチメモリページ(ブロック)を割り当て、それを指すようにbufferを設定する。
ブロック内で使用可能なメモリの量はPF_PAGE_SIZE + 4 = 4096バイトになる。
スクラッチページはバッファプールに自動的に固定される。

**RC DisposeBlock (char *buffer)**
このメソッドはbufferが指すバッファプール内のスクラッチページを破棄する。
このスクラッチページはPF_Manager::AllocateBlockによって事前に割り当てられている必要がある。
固定と固定解除と同様にPF_Manager::DisposeBlockを呼び出して取得したバッファブロックごとにPF_Manager::AllocateBlockによって
事前に割り当てられている必要がある。そうしないとバッファプール内のページが永久に失われる。

